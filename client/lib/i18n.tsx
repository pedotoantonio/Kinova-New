import React, { createContext, useContext, useState, useCallback, ReactNode } from "react";
import AsyncStorage from "@react-native-async-storage/async-storage";

export type Language = "it" | "en";

const translations = {
  it: {
    common: {
      loading: "Caricamento...",
      error: "Errore",
      retry: "Riprova",
      cancel: "Annulla",
      save: "Salva",
      delete: "Elimina",
      edit: "Modifica",
      create: "Crea",
      confirm: "Conferma",
      yes: "Sì",
      no: "No",
      today: "Oggi",
      tomorrow: "Domani",
      yesterday: "Ieri",
    },
    auth: {
      login: "Accedi",
      logout: "Esci",
      register: "Registrati",
      pleaseLogin: "Effettua l'accesso",
      welcomeBack: "Bentornato",
      createYourAccount: "Crea il tuo account",
      createAccount: "Crea Account",
      alreadyHaveAccount: "Hai già un account? Accedi",
      createNewAccount: "Crea nuovo account",
      continueAsGuest: "Continua come ospite",
      enterCredentials: "Inserisci username e password",
      authFailed: "Autenticazione fallita",
      guestLoginFailed: "Login ospite fallito",
      or: "oppure",
      username: "Nome utente",
      password: "Password",
      displayNameOptional: "Nome visualizzato (opzionale)",
      confirmLogout: "Sei sicuro di voler uscire?",
    },
    home: {
      title: "Home",
      welcomeTo: "Benvenuto in",
      yourFamily: "La tua Famiglia",
      familyMembers: "Membri della Famiglia",
      noFamilyMembers: "Nessun membro ancora",
      todayEvents: "Oggi",
      noEventsToday: "Nessun impegno oggi",
      viewCalendar: "Vedi calendario",
      member: "membro",
      members: "membri",
      shoppingList: "Lista Spesa",
      nothingToBuy: "Niente da comprare",
      viewShopping: "Vedi lista",
      pendingTasks: "Attività",
      noTasksPending: "Nessuna attività",
      viewTasks: "Vedi attività",
      overdue: "scaduta",
      overdueCount: "{count} scadute",
      monthlyBudget: "Budget mensile",
      viewBudget: "Vedi budget",
    },
    calendar: {
      title: "Calendario",
      addEvent: "Aggiungi evento",
      noEvents: "Nessun evento",
      noUpcomingEvents: "Nessun evento in programma",
      eventTitle: "Titolo evento",
      eventDescription: "Descrizione",
      shortCode: "Codice breve",
      shortCodeHint: "Es. MM, CF, AP",
      startDate: "Data inizio",
      endDate: "Data fine",
      allDay: "Tutto il giorno",
      selectColor: "Seleziona colore",
      category: "Categoria",
      assignTo: "Assegna a",
      deleteEvent: "Elimina evento",
      deleteConfirm: "Sei sicuro di voler eliminare questo evento?",
      eventCreated: "Evento creato",
      eventUpdated: "Evento aggiornato",
      eventDeleted: "Evento eliminato",
      titleRequired: "Il titolo è obbligatorio",
      moreEvents: "+{count} altri",
      viewAll: "Vedi tutti",
      sun: "Dom",
      mon: "Lun",
      tue: "Mar",
      wed: "Mer",
      thu: "Gio",
      fri: "Ven",
      sat: "Sab",
      weekend: "Fine settimana",
      months: [
        "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
        "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"
      ],
      categories: {
        family: "Famiglia",
        course: "Corso",
        shift: "Turno",
        vacation: "Ferie",
        holiday: "Festività",
        other: "Altro",
      },
      recurrence: {
        title: "Ricorrenza",
        none: "Nessuna",
        daily: "Giornaliera",
        weekly: "Settimanale",
        monthly: "Mensile",
        interval: "Ogni",
        days: "giorni",
        weeks: "settimane",
        months: "mesi",
        endDate: "Data fine ricorrenza",
        noEnd: "Senza fine",
      },
      filters: {
        title: "Filtri",
        all: "Tutti",
        byCategory: "Per categoria",
        byMember: "Per membro",
        reset: "Azzera filtri",
        active: "Filtri attivi",
      },
    },
    tasks: {
      title: "Attività",
      addTask: "Aggiungi attività",
      noTasks: "Nessuna attività",
      completed: "Completate",
      pending: "In sospeso",
      overdue: "Scadute",
      all: "Tutte",
      taskTitle: "Titolo attività",
      taskDescription: "Descrizione",
      dueDate: "Scadenza",
      assignTo: "Assegna a",
      priority: "Priorità",
      priorityLow: "Bassa",
      priorityMedium: "Media",
      priorityHigh: "Alta",
      deleteTask: "Elimina attività",
      deleteConfirm: "Sei sicuro di voler eliminare questa attività?",
      markComplete: "Segna come completata",
      markIncomplete: "Segna come da fare",
      noAssignment: "Non assegnata",
      titleRequired: "Il titolo è obbligatorio",
    },
    shopping: {
      title: "Lista spesa",
      addItem: "Aggiungi prodotto",
      noItems: "Niente da comprare",
      nothingToBuy: "Niente da comprare",
      purchased: "Acquistati",
      toBuy: "Da comprare",
      all: "Tutti",
      itemName: "Nome prodotto",
      quantity: "Quantità",
      unit: "Unità",
      category: "Categoria",
      deleteItem: "Elimina prodotto",
      deleteConfirm: "Sei sicuro di voler eliminare questo prodotto?",
      markPurchased: "Segna come acquistato",
      markToBuy: "Segna come da comprare",
      nameRequired: "Il nome è obbligatorio",
    },
    lists: {
      title: "Liste",
      shopping: "Spesa",
      tasks: "Attività",
    },
    budget: {
      title: "Budget",
      addExpense: "Aggiungi spesa",
      noExpenses: "Nessuna spesa registrata",
      amount: "Importo",
      amountPlaceholder: "0,00",
      description: "Descrizione",
      descriptionPlaceholder: "Es. Spesa al supermercato",
      category: "Categoria",
      date: "Data",
      paidBy: "Pagato da",
      monthly: "Mensile",
      thisMonth: "Questo mese",
      breakdown: "Ripartizione",
      recentExpenses: "Spese recenti",
      total: "Totale",
      deleteExpense: "Elimina spesa",
      deleteConfirm: "Sei sicuro di voler eliminare questa spesa?",
      amountRequired: "L'importo è obbligatorio",
      amountPositive: "L'importo deve essere maggiore di zero",
      descriptionRequired: "La descrizione è obbligatoria",
      categories: {
        home: "Casa",
        groceries: "Spesa alimentare",
        school: "Scuola",
        transport: "Trasporti",
        leisure: "Tempo libero",
        other: "Altro",
      },
      monthlySpent: "Speso questo mese",
      noData: "Nessun dato",
      viewAll: "Vedi tutto",
    },
    profile: {
      title: "Profilo",
      settings: "Impostazioni",
      language: "Lingua",
      theme: "Tema",
      about: "Informazioni",
      city: "Città",
      selectCity: "Seleziona città",
      searchCity: "Cerca città...",
      noResults: "Nessun risultato",
      cityUpdated: "Città aggiornata",
      userId: "ID Utente",
      familyId: "ID Famiglia",
      role: "Ruolo",
      member: "Membro",
      none: "Nessuno",
    },
    weather: {
      title: "Meteo",
      current: "Adesso",
      today: "Oggi",
      tomorrow: "Domani",
      feelsLike: "Percepita",
      humidity: "Umidità",
      wind: "Vento",
      precipChance: "Probabilità pioggia",
      noCity: "Nessuna città impostata",
      setCity: "Imposta città",
      updating: "Aggiornamento...",
      lastUpdate: "Ultimo aggiornamento",
      high: "Max",
      low: "Min",
    },
    family: {
      admin: "Admin",
      member: "Membro",
      child: "Bambino",
      you: "Tu",
    },
    errors: {
      networkError: "Errore di rete",
      serverError: "Errore del server",
      notFound: "Non trovato",
      unauthorized: "Non autorizzato",
      forbidden: "Accesso negato",
      validationError: "Errore di validazione",
    },
    assistant: {
      title: "Assistente",
      newChat: "Nuova chat",
      placeholder: "Scrivi un messaggio...",
      send: "Invia",
      stop: "Stop",
      stopped: "Interrotto",
      thinking: "Sto pensando...",
      attachFile: "Allega file",
      attachPhoto: "Scatta foto",
      attachGallery: "Scegli dalla galleria",
      uploadingFile: "Caricamento file...",
      fileUploaded: "File caricato",
      confirm: "Conferma",
      cancel: "Annulla",
      actionConfirm: "Vuoi confermare questa azione?",
      actionSuccess: "Azione completata",
      actionError: "Errore durante l'azione",
      noConversations: "Nessuna conversazione",
      startChat: "Inizia a chattare con l'assistente",
      deleteChat: "Elimina conversazione",
      deleteConfirm: "Eliminare questa conversazione?",
      permissionRequired: "Permesso richiesto per accedere a questa funzione",
      copy: "Copia",
      retry: "Riprova",
      regenerate: "Rigenera",
      analyzing: "Analisi in corso...",
      copied: "Copiato",
      confirmAction: "Confermare questa azione?",
      confirmCreateEvent: "Creare questo evento?",
      confirmUpdateEvent: "Modificare questo evento?",
      confirmDeleteEvent: "Eliminare questo evento?",
      confirmCreateTask: "Creare questa attività?",
      confirmCompleteTask: "Completare questa attività?",
      confirmDeleteTask: "Eliminare questa attività?",
      confirmAddShopping: "Aggiungere alla lista della spesa?",
      confirmRemoveShopping: "Rimuovere dalla lista della spesa?",
      confirmAddExpense: "Registrare questa spesa?",
    },
  },
  en: {
    common: {
      loading: "Loading...",
      error: "Error",
      retry: "Retry",
      cancel: "Cancel",
      save: "Save",
      delete: "Delete",
      edit: "Edit",
      create: "Create",
      confirm: "Confirm",
      yes: "Yes",
      no: "No",
      today: "Today",
      tomorrow: "Tomorrow",
      yesterday: "Yesterday",
    },
    auth: {
      login: "Login",
      logout: "Logout",
      register: "Register",
      pleaseLogin: "Please log in",
      welcomeBack: "Welcome back",
      createYourAccount: "Create your account",
      createAccount: "Create Account",
      alreadyHaveAccount: "Already have an account? Login",
      createNewAccount: "Create new account",
      continueAsGuest: "Continue as guest",
      enterCredentials: "Please enter username and password",
      authFailed: "Authentication failed",
      guestLoginFailed: "Guest login failed",
      or: "or",
      username: "Username",
      password: "Password",
      displayNameOptional: "Display Name (optional)",
      confirmLogout: "Are you sure you want to logout?",
    },
    home: {
      title: "Home",
      welcomeTo: "Welcome to",
      yourFamily: "Your Family",
      familyMembers: "Family Members",
      noFamilyMembers: "No family members yet",
      todayEvents: "Today",
      noEventsToday: "No events today",
      viewCalendar: "View calendar",
      member: "member",
      members: "members",
      shoppingList: "Shopping List",
      nothingToBuy: "Nothing to buy",
      viewShopping: "View list",
      pendingTasks: "Tasks",
      noTasksPending: "No pending tasks",
      viewTasks: "View tasks",
      overdue: "overdue",
      overdueCount: "{count} overdue",
      monthlyBudget: "Monthly budget",
      viewBudget: "View budget",
    },
    calendar: {
      title: "Calendar",
      addEvent: "Add event",
      noEvents: "No events",
      noUpcomingEvents: "No upcoming events",
      eventTitle: "Event title",
      eventDescription: "Description",
      shortCode: "Short code",
      shortCodeHint: "E.g. MM, CF, AP",
      startDate: "Start date",
      endDate: "End date",
      allDay: "All day",
      selectColor: "Select color",
      category: "Category",
      assignTo: "Assign to",
      deleteEvent: "Delete event",
      deleteConfirm: "Are you sure you want to delete this event?",
      eventCreated: "Event created",
      eventUpdated: "Event updated",
      eventDeleted: "Event deleted",
      titleRequired: "Title is required",
      moreEvents: "+{count} more",
      viewAll: "View all",
      sun: "Sun",
      mon: "Mon",
      tue: "Tue",
      wed: "Wed",
      thu: "Thu",
      fri: "Fri",
      sat: "Sat",
      weekend: "Weekend",
      months: [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ],
      categories: {
        family: "Family",
        course: "Course",
        shift: "Shift",
        vacation: "Vacation",
        holiday: "Holiday",
        other: "Other",
      },
      recurrence: {
        title: "Recurrence",
        none: "None",
        daily: "Daily",
        weekly: "Weekly",
        monthly: "Monthly",
        interval: "Every",
        days: "days",
        weeks: "weeks",
        months: "months",
        endDate: "Recurrence end date",
        noEnd: "No end",
      },
      filters: {
        title: "Filters",
        all: "All",
        byCategory: "By category",
        byMember: "By member",
        reset: "Reset filters",
        active: "Active filters",
      },
    },
    tasks: {
      title: "Tasks",
      addTask: "Add task",
      noTasks: "No tasks",
      completed: "Completed",
      pending: "Pending",
      overdue: "Overdue",
      all: "All",
      taskTitle: "Task title",
      taskDescription: "Description",
      dueDate: "Due date",
      assignTo: "Assign to",
      priority: "Priority",
      priorityLow: "Low",
      priorityMedium: "Medium",
      priorityHigh: "High",
      deleteTask: "Delete task",
      deleteConfirm: "Are you sure you want to delete this task?",
      markComplete: "Mark as complete",
      markIncomplete: "Mark as incomplete",
      noAssignment: "Unassigned",
      titleRequired: "Title is required",
    },
    shopping: {
      title: "Shopping list",
      addItem: "Add item",
      noItems: "Nothing to buy",
      nothingToBuy: "Nothing to buy",
      purchased: "Purchased",
      toBuy: "To buy",
      all: "All",
      itemName: "Item name",
      quantity: "Quantity",
      unit: "Unit",
      category: "Category",
      deleteItem: "Delete item",
      deleteConfirm: "Are you sure you want to delete this item?",
      markPurchased: "Mark as purchased",
      markToBuy: "Mark as to buy",
      nameRequired: "Name is required",
    },
    lists: {
      title: "Lists",
      shopping: "Shopping",
      tasks: "Tasks",
    },
    budget: {
      title: "Budget",
      addExpense: "Add expense",
      noExpenses: "No expenses recorded",
      amount: "Amount",
      amountPlaceholder: "0.00",
      description: "Description",
      descriptionPlaceholder: "E.g. Grocery shopping",
      category: "Category",
      date: "Date",
      paidBy: "Paid by",
      monthly: "Monthly",
      thisMonth: "This month",
      breakdown: "Breakdown",
      recentExpenses: "Recent expenses",
      total: "Total",
      deleteExpense: "Delete expense",
      deleteConfirm: "Are you sure you want to delete this expense?",
      amountRequired: "Amount is required",
      amountPositive: "Amount must be greater than zero",
      descriptionRequired: "Description is required",
      categories: {
        home: "Home",
        groceries: "Groceries",
        school: "School",
        transport: "Transport",
        leisure: "Leisure",
        other: "Other",
      },
      monthlySpent: "Spent this month",
      noData: "No data",
      viewAll: "View all",
    },
    profile: {
      title: "Profile",
      settings: "Settings",
      language: "Language",
      theme: "Theme",
      about: "About",
      city: "City",
      selectCity: "Select city",
      searchCity: "Search city...",
      noResults: "No results",
      cityUpdated: "City updated",
      userId: "User ID",
      familyId: "Family ID",
      role: "Role",
      member: "Member",
      none: "None",
    },
    weather: {
      title: "Weather",
      current: "Now",
      today: "Today",
      tomorrow: "Tomorrow",
      feelsLike: "Feels like",
      humidity: "Humidity",
      wind: "Wind",
      precipChance: "Precipitation chance",
      noCity: "No city set",
      setCity: "Set city",
      updating: "Updating...",
      lastUpdate: "Last update",
      high: "High",
      low: "Low",
    },
    family: {
      admin: "Admin",
      member: "Member",
      child: "Child",
      you: "You",
    },
    errors: {
      networkError: "Network error",
      serverError: "Server error",
      notFound: "Not found",
      unauthorized: "Unauthorized",
      forbidden: "Access denied",
      validationError: "Validation error",
    },
    assistant: {
      title: "Assistant",
      newChat: "New chat",
      placeholder: "Type a message...",
      send: "Send",
      stop: "Stop",
      stopped: "Stopped",
      thinking: "Thinking...",
      attachFile: "Attach file",
      attachPhoto: "Take photo",
      attachGallery: "Choose from gallery",
      uploadingFile: "Uploading file...",
      fileUploaded: "File uploaded",
      confirm: "Confirm",
      cancel: "Cancel",
      actionConfirm: "Do you want to confirm this action?",
      actionSuccess: "Action completed",
      actionError: "Action failed",
      noConversations: "No conversations",
      startChat: "Start chatting with the assistant",
      deleteChat: "Delete conversation",
      deleteConfirm: "Delete this conversation?",
      permissionRequired: "Permission required to access this feature",
      copy: "Copy",
      retry: "Retry",
      regenerate: "Regenerate",
      analyzing: "Analyzing...",
      copied: "Copied",
      confirmAction: "Confirm this action?",
      confirmCreateEvent: "Create this event?",
      confirmUpdateEvent: "Update this event?",
      confirmDeleteEvent: "Delete this event?",
      confirmCreateTask: "Create this task?",
      confirmCompleteTask: "Complete this task?",
      confirmDeleteTask: "Delete this task?",
      confirmAddShopping: "Add to shopping list?",
      confirmRemoveShopping: "Remove from shopping list?",
      confirmAddExpense: "Record this expense?",
    },
  },
} as const;

type DeepStringify<T> = T extends readonly string[]
  ? readonly string[]
  : T extends object
  ? { [K in keyof T]: DeepStringify<T[K]> }
  : T extends string
  ? string
  : T;

type TranslationKeys = DeepStringify<typeof translations["it"]>;

interface I18nContextType {
  language: Language;
  setLanguage: (lang: Language) => Promise<void>;
  t: TranslationKeys;
}

const I18nContext = createContext<I18nContextType | null>(null);

const STORAGE_KEY = "@kinova/language";

export function I18nProvider({ children }: { children: ReactNode }) {
  const [language, setLanguageState] = useState<Language>("it");
  const [isLoaded, setIsLoaded] = useState(false);

  React.useEffect(() => {
    AsyncStorage.getItem(STORAGE_KEY).then((stored) => {
      if (stored === "en" || stored === "it") {
        setLanguageState(stored);
      }
      setIsLoaded(true);
    });
  }, []);

  const setLanguage = useCallback(async (lang: Language) => {
    setLanguageState(lang);
    await AsyncStorage.setItem(STORAGE_KEY, lang);
  }, []);

  const value: I18nContextType = {
    language,
    setLanguage,
    t: translations[language] as TranslationKeys,
  };

  if (!isLoaded) {
    return null;
  }

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n(): I18nContextType {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error("useI18n must be used within an I18nProvider");
  }
  return context;
}

export function useTranslation() {
  const { t, language } = useI18n();
  return { t, language };
}
